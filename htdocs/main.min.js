var AssetAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getAsset=function(t,e,i){function n(n){e.call(i,n,t)}if(RES.hasRes(t)){var s=RES.getRes(t);s?n(s):RES.getResAsync(t,n,this)}else RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_IMAGE)},t}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var BaseComponent=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.load=function(t){this.addEventListener(eui.UIEvent.COMPLETE,this.onUIComplete,this),this.skinName="resource/eui_skins/"+t},n.onUIComplete=function(t){this.removeEventListener(eui.UIEvent.COMPLETE,this.onUIComplete,this),this.initComponent()},n.initComponent=function(){},e}(eui.Component);egret.registerClass(BaseComponent,"BaseComponent");var UserData=function(){function t(){}var e=(__define,t);e.prototype;return t}();egret.registerClass(UserData,"UserData");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center",this.addChild(this.textField)},n.setLoadingText=function(t){this.textField.text=t},n.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.alertView=null,this.topbar=null,this.home=null,this.current=null,this.indexScene=null,this.gameScene=null,e.instance=this}__extends(e,t);var i=(__define,e),n=i.prototype;return e.getInstance=function(){return e.instance},n.createChildren=function(){t.prototype.createChildren.call(this);var e=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",e),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.addChild(this.loadingView),this.loadingView.setLoadingText("正在加载配置"),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json?v="+Math.random(),"resource/")},n.loadRes=function(t){this.loadingView.visible||(this.loadingView.visible=!0,this.addChild(this.loadingView)),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup(t)},n.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),this.loadingView.setLoadingText("正在加载皮肤主题");var e=new eui.Theme("resource/default.thm.json?v="+Math.random(),this.stage);e.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),this.loadRes("preload")},n.onThemeLoadComplete=function(){this.alertView=new Alert,this.alertView.horizontalCenter=0,this.alertView.verticalCenter=0,this.loadingView.setLoadingText("正在加载资源"),this.loadRes("preload")},n.onResourceLoadComplete=function(t){RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),"preload"==t.groupName?this.createScene():"game"==t.groupName&&this.initGame()},n.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},n.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},n.onResourceProgress=function(t){this.loadingView.setLoadingText("Loading..."+Math.ceil(t.itemsLoaded/t.itemsTotal*100)+"%")},n.initGame=function(){this.net=new Network,this.net.setConnectHandler(this.onServerConnected,this),this.net.setCloseHandler(this.onServerClosed,this),this.loadingView.setLoadingText("正在获取服务器信息");var t=new egret.HttpRequest;t.responseType=egret.HttpResponseType.TEXT,t.open("http://"+location.host+"/api.php?cmd=getserver&r="+Math.random()),t.addEventListener(egret.Event.COMPLETE,function(e){var i=JSON.parse(t.response);this.loadingView.setLoadingText("正在连接服务器"),this.net.connect(i.host,i.port)},this),t.addEventListener(egret.IOErrorEvent.IO_ERROR,function(){this.loadingView.setLoadingText("获取服务器失败")},this),t.send()},n.onServerConnected=function(){this.net.bind("Index.login",this.onLogin,this),this.net.bind("Error",this.onError,this),this.loadingView.setLoadingText("正在登录"),this.net.send("Index","login",{username:this.username,token:this.token})},n.onServerClosed=function(){this.net.isConnected()?Alert.show("与服务器断开连接",!1,function(){window.location.reload()},this):Alert.show("无法连接服务器",!1)},n.onError=function(t){Alert.show(t)},n.onLogin=function(t){this.user=new UserData,this.user.uid=t.uid,this.user.username=t.username,this.user.nickname=t.nickname,this.user.avatar=t.avatar,this.user.gamepoint=t.gamepoint,this.user.gold=t.gold,this.user.roomid=t.roomid,this.user.seatid=t.seatid,this.createGame()},n.createScene=function(){this.loadingView.visible=!1,this.removeChildren();var t=new Login;this.addChild(t)},n.createGame=function(){this.loadingView.visible=!1,this.removeChildren();var t=new egret.Bitmap(RES.getRes("bg"));this.addChild(t),this.home=new egret.DisplayObjectContainer,this.home.width=this.stage.stageWidth,this.home.height=this.stage.stageHeight,this.addChild(this.home),this.topbar=new Topbar,this.addChild(this.topbar),this.topbar.labelName.text=this.user.nickname,this.topbar.labelGold.text=this.user.gold+"",this.topbar.imgAvatar.source=this.user.avatar?Utils.imageProxyUrl(this.user.avatar):"face_jpg",this.showIndexScene()},n.display=function(t){this.current&&this.home.removeChild(this.current),this.current=t,this.home.addChild(this.current)},n.showIndexScene=function(){this.indexScene||(this.indexScene=new Index),this.indexScene.hideInput(),this.display(this.indexScene)},n.showGameScene=function(){this.gameScene||(this.gameScene=new Game),this.net.send("Room","info",{roomid:this.user.roomid}),this.display(this.gameScene)},n.updateTopbar=function(){this.topbar.labelGold.text=this.user.gold+""},e}(eui.UILayer);egret.registerClass(Main,"Main");var Network=function(){function t(){this.handler={},this.socket=new egret.WebSocket,this.socket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onSocketData,this),this.socket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.socket.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.socket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSocketError,this)}var e=(__define,t),i=e.prototype;return i.setConnectHandler=function(t,e){this.cbConnect=[e,t]},i.setCloseHandler=function(t,e){this.cbClose=[e,t]},i.setErrorHandler=function(t,e){this.cbError=[e,t]},i.connect=function(t,e){this.state=0,this.host=t,this.port=e,this.socket.connect(t,e)},i.reconnect=function(){this.connect(this.host,this.port)},i.bind=function(t,e,i){this.handler[t]=[i,e]},i.send=function(t,e,i){var n={c:t,m:e,data:i};console.log("send -->",JSON.stringify(n)),this.socket.writeUTF(JSON.stringify(n))},i.isConnected=function(){return 1==this.state},i.onSocketOpen=function(){if(console.log("websocket connected"),this.cbConnect.length>0){var t=this.cbConnect[0],e=this.cbConnect[1];e.call(t)}this.state=1},i.onSocketClose=function(){if(console.log("websocket closed"),this.cbClose.length>0){var t=this.cbClose[0],e=this.cbClose[1];e.call(t)}},i.onSocketError=function(){if(console.log("websocket error"),this.cbError.length>0){var t=this.cbError[0],e=this.cbError[1];e.call(t)}},i.onSocketData=function(t){var e=this.socket.readUTF();console.log("recv -->",e);var i=JSON.parse(e);this.dispatch(i)},i.dispatch=function(t){var e=t.err,i=e?"Error":t.c+"."+t.m,n=this.handler[i];if(n){var s=n[0],o=n[1];o.call(s,t.data)}else console.log("not found handler --> "+i)},t}();egret.registerClass(Network,"Network");var Alert=function(t){function e(){t.call(this),e.instance=this,this.load("component/AlertSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initComponent=function(){this.btnOk.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onButtonTouchBegin,this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_END,this.onButtonTouchEnd,this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onButtonTouchBegin,this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_END,this.onButtonTouchEnd,this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchCancel,this)},n.onButtonTouchBegin=function(t){t.target.scaleX=.9,t.target.scaleY=.9},n.onButtonTouchEnd=function(t){t.target.scaleX=1,t.target.scaleY=1},n.onTouch=function(t){this.parent.removeChild(this),this.func&&this.func.call(this.obj)},n.onTouchCancel=function(t){this.parent.removeChild(this),this.cfunc&&this.cfunc.call(this.obj)},e.show=function(t,i,n,s,o,a){void 0===i&&(i=!0),void 0===n&&(n=null),void 0===s&&(s=null),void 0===o&&(o=!1),void 0===a&&(a=null),i&&(t=e.texts[t]);var h=e.instance;h.labText.text=t,h.func=n,h.cfunc=a,h.obj=s,o?(h.btnOk.x=95,h.btnCancel.x=226,h.btnCancel.visible=!0):(h.btnOk.x=h.width/2,h.btnCancel.visible=!1),Main.getInstance().addChild(h)},e.texts={InvalidToken:"登录验证失败",GoldLess:"钻石少于5个不能进入房间",InRoom:"你已经有房间了，点击进入即可",CreateFailed:"创建房间出现了异常",InvalidRoomId:"房间不存在",RoomNotFound:"房间不存在",Already:"已经准备了",PlayerStateError:"还有玩家没有准备",PlayerLess:"一个人怎么玩?还不赶快邀请你的基友互相伤害!",RaiseFailed:"跟注错误",FollowFailed:"加注错误",LookFailed:"看牌错误",GiveupFailed:"放弃错误",PkFailed:"比牌错误",UserNotExists:"用户不存在"},e}(BaseComponent);egret.registerClass(Alert,"Alert");var Balance=function(t){function e(e,i,n,s){t.call(this),this.doneFunc=null,this.doneObj=null,this.steptext=i,this.btntext=n,this.users=e,this.balance=s,this.width=326,this.height=449,this.load("component/BalanceSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.setDoneHandler=function(t,e,i){this.doneFunc=t,this.doneObj=e,this.doneArgs=i},n.initComponent=function(){for(var t=this,e=0;5>e;++e){var i=this["grpBox"+(e+1)];if(e>=this.users.length)i.visible=!1;else{i.visible=!0;var n=this.users[e],s=this["labName"+(e+1)],o=this["labGold"+(e+1)];if(s.text=n.name,o.text=n.point>0?"+"+n.point:n.point,this.balance){if(n.king){var a=new egret.Bitmap(RES.getRes("balance_king_png"));a.x=225,a.y=3,a.scaleX=.6,a.scaleY=.6,i.addChild(a)}}else for(var h=n.cards,r=0;3>r;++r){var l=Math.floor(h[r]/100),d=h[r]%100,c=new Card(l,d);c.scaleX=.5,c.scaleY=.5,c.x=205+20*r,c.y=3,i.addChild(c)}i.x=e%2==0?-303:326;var u=egret.Tween.get(i);u.to({x:23},300)}}this.labStep.text=this.steptext,this.btnOk.label=this.btntext,this.btnOk.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.btnOk.scaleX=.9,t.btnOk.scaleY=.9},this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.btnOk.scaleX=1,t.btnOk.scaleY=1},this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this)},n.onTouch=function(t){this.doneFunc?this.doneFunc.apply(this.doneObj,this.doneArgs):this.parent.removeChild(this)},e}(BaseComponent);egret.registerClass(Balance,"Balance");var Card=function(t){function e(e,i){t.call(this),this.color=e,this.value=i;var n=new egret.Bitmap(RES.getRes("card_front_png"));this.height=n.height-1,this.addChild(n);var s=1==e||3==e?"card_value_black_":"card_value_red_",o=new egret.Bitmap(RES.getRes(s+i+"_png"));o.x=5,o.y=5,this.addChild(o);var a=new egret.Bitmap(RES.getRes("card_color_"+e+"_png"));a.x=5,a.y=28,this.addChild(a)}__extends(e,t);var i=(__define,e);i.prototype;return e}(egret.Sprite);egret.registerClass(Card,"Card");var GameButton=function(t){function e(e,i,n,s){t.call(this),this.btnName=e,this.btnText=i,this.enableSource=n,this.disableSource=s,this.load("component/GameButtonSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.setEnable=function(t){var e=this.enabled;this.enabled=t,e!=t&&(this.imgIcon.source=t?this.enableSource:this.disableSource)},n.setLable=function(t){this.labText.text=t,this.btnText=t},n.initComponent=function(){var t=this;this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.scaleX=.9,t.scaleY=.9},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.scaleX=1,t.scaleY=1},this),this.width=83,this.height=112,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.labName.text=this.btnName,this.labText.text=this.btnText,this.imgIcon.source=this.enableSource},e}(BaseComponent);egret.registerClass(GameButton,"GameButton");var Topbar=function(t){function e(){t.call(this),this.init=!1,this.load("game/TopbarSkin.exml")}__extends(e,t);var i=(__define,e);i.prototype;return e}(BaseComponent);egret.registerClass(Topbar,"Topbar");var VS=function(t){function e(e,i){t.call(this),this.func=null,this.data=e,this.loser=i,this.load("component/VSSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.setDoneHandler=function(t,e,i){this.func=t,this.obj=e,this.args=i},n.initComponent=function(){var t=this;this.labName1.text=this.data[0].name,this.labName2.text=this.data[1].name,this.labPoint1.text=this.data[0].point,this.labPoint2.text=this.data[1].point,this.grpLeft.x=-300;var e=egret.Tween.get(this.grpLeft);e.to({x:-20},300),this.grpRight.x=485;var i=egret.Tween.get(this.grpRight);i.to({x:193},300);var n=egret.Tween.get(this.imgLose);this.imgLose.x=1==this.loser?88:391,this.imgLose.y=1==this.loser?73:96,this.imgLose.scaleX=5,this.imgLose.scaleY=5,n.wait(400).to({visible:!0},1).to({scaleX:1,scaleY:1},300).call(function(){t.func&&t.func.apply(t.obj,t.args)},this,[])},e}(BaseComponent);egret.registerClass(VS,"VS");var Game=function(t){function e(){t.call(this),this.seatid=0,this.state=0,this.current=0,this.coins=[],this.cards=[],this.pklist=[],this.op=!1,this.timer=null,this.timerSecond=0,this.pking=!1,this.main=Main.getInstance(),this.net=this.main.net,this.initNetwork(),this.load("game/GameSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initComponent=function(){this.seats=[new Seat,new Seat,new Seat,new Seat,new Seat];for(var t=1;4>=t;++t){var e=this.seats[t];e.grpBox=this["seat"+t],e.imgAvatar=this["faceImg"+t],e.labName=this["nameLabel"+t],e.labTotal=this["goldLabel"+t],e.imgCard1=this["cardaImg"+t],e.imgCard2=this["cardbImg"+t],e.imgCard3=this["cardcImg"+t],e.imgState=this["statImg"+t],e.imgBg=this["imgBg"+t]}this.seats[0].active=!0,this.seats[0].myself=!0,this.seats[0].labTotal=this.labMyTotal,this.seats[0].labPoint=this.labMyPoint,this.imgMyCard1=new egret.Sprite,this.imgMyCard1.x=177,this.imgMyCard1.y=697,this.addChild(this.imgMyCard1),this.imgMyCard2=new egret.Sprite,this.imgMyCard2.x=217,this.imgMyCard2.y=697,this.addChild(this.imgMyCard2),this.imgMyCard3=new egret.Sprite,this.imgMyCard3.x=257,this.imgMyCard3.y=697,this.addChild(this.imgMyCard3),this.setChildIndex(this.btnLook,this.getChildIndex(this.imgMyCard3)+1),this.btnStartGame.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBegin,this),this.btnDisband.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Alert.show("确定解散房间吗？",!1,function(){this.main.net.send("Room","disband",null)},this,!0)},this),this.btnStartGame.visible=!1,this.btnDisband.visible=!1,this.btnLook.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.main.net.send("Room","look",null)},this),this.btnRaise=new GameButton("加注","","raise_enable_png","raise_disable_png"),this.btnRaise.visible=!1,this.addChild(this.btnRaise),this.btnRaise.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.main.net.send("Room","raise",null)},this),this.btnFollow=new GameButton("跟注","","follow_enable_png","follow_disable_png"),this.btnFollow.visible=!1,this.addChild(this.btnFollow),this.btnFollow.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.main.net.send("Room","follow",null)},this),this.btnGiveup=new GameButton("弃牌","","giveup_enable_png","giveup_disable_png"),this.btnGiveup.visible=!1,this.addChild(this.btnGiveup),this.btnGiveup.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.main.net.send("Room","giveup",null)},this),this.btnPk=new GameButton("比牌","","pk_enable_png","pk_enable_png"),this.btnPk.visible=!1,this.addChild(this.btnPk),this.btnPk.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){var t=new egret.Bitmap(RES.getRes("topbar_bg_png"));t.width=this.width,t.height=this.height,t.touchEnabled=!0,t.alpha=.3,t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.cancelPk,this),this.pklist.push(t),this.addChild(t);var e=new eui.Label;e.verticalCenter=0,e.horizontalCenter=0,e.text="点击玩家头像比牌",e.fontFamily="微软雅黑",e.size=22,this.addChild(e),this.pklist.push(e);for(var i=1;i<this.seats.length;++i){var n=this.seats[i];if(2==n.state){var s=new egret.Bitmap(RES.getRes("pk_png"));s.scale9Grid=new egret.Rectangle(15,15,64,55),s.width=n.imgBg.width+2,s.height=n.imgBg.height+2,s.x=n.grpBox.x+n.imgBg.x-2,s.y=n.grpBox.y+n.imgBg.y-2,s.name=n.pos+"",s.touchEnabled=!0,s.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchPk,this),this.pklist.push(s),this.addChild(s)}}},this)},n.initNetwork=function(){this.net.bind("Room.info",this.onInfo,this),this.net.bind("Room.ready",this.onReady,this),this.net.bind("Room.start",this.onStart,this),this.net.bind("Room.raise",this.onRaise,this),this.net.bind("Room.join",this.onJoin,this),this.net.bind("Room.look",this.onLook,this),this.net.bind("Room.look2",this.onLook2,this),this.net.bind("Room.follow",this.onFollow,this),this.net.bind("Room.giveup",this.onGiveup,this),this.net.bind("Room.pk",this.onPK,this),this.net.bind("Room.over",this.onOver,this),this.net.bind("Room.online",this.onOnline,this),this.net.bind("Room.offline",this.onOffline,this),this.net.bind("Room.disband",this.onDisband,this)},n.onTouchPk=function(t){var e=t.target.name;this.main.net.send("Room","pk",{seatid:e}),this.cancelPk()},n.cancelPk=function(){for(var t in this.pklist)this.removeChild(this.pklist[t]);this.pklist=[]},n.getSeatByPos=function(t){var e=[[0,3,4,1,2],[2,0,3,4,1],[1,2,0,3,4],[4,1,2,0,3],[3,4,1,2,0]],i=e[this.seatid-1][t-1];return this.seats[i]},n.showButtons=function(t){if(console.log("show buttons="+t),t)this.btnRaise.x=this.imgMyCard2.x,this.btnRaise.y=this.imgMyCard2.y,this.btnRaise.alpha=.5,this.btnRaise.visible=!0,this.btnFollow.x=this.imgMyCard2.x,this.btnFollow.y=this.imgMyCard2.y,this.btnFollow.alpha=.5,this.btnFollow.visible=!0,this.btnGiveup.x=this.imgMyCard2.x,this.btnGiveup.y=this.imgMyCard2.y,this.btnGiveup.alpha=.5,this.btnGiveup.visible=!0,this.btnPk.x=this.imgMyCard2.x,this.btnPk.y=this.imgMyCard2.y,this.btnPk.alpha=.5,this.btnPk.visible=!0,egret.Tween.removeTweens(this.btnGiveup),egret.Tween.removeTweens(this.btnRaise),egret.Tween.removeTweens(this.btnFollow),egret.Tween.removeTweens(this.btnPk),egret.Tween.get(this.btnGiveup).to({x:85.5,y:666,alpha:1},300),egret.Tween.get(this.btnRaise).to({x:167.5,y:596,alpha:1},300),egret.Tween.get(this.btnFollow).to({x:320.5,y:596,alpha:1},300),egret.Tween.get(this.btnPk).to({x:397.5,y:666,alpha:1},300);else if(1==this.op){var e=this.imgMyCard2.x,i=this.imgMyCard2.y;egret.Tween.get(this.btnGiveup).to({x:e,y:i,alpha:.5},300).call(function(t){t.visible=!1},this,[this.btnGiveup]),egret.Tween.get(this.btnRaise).to({x:e,y:i,alpha:.5},300).call(function(t){t.visible=!1},this,[this.btnRaise]),egret.Tween.get(this.btnFollow).to({x:e,y:i,alpha:.5},300).call(function(t){t.visible=!1},this,[this.btnFollow]),egret.Tween.get(this.btnPk).to({x:e,y:i,alpha:.5},300).call(function(t){t.visible=!1},this,[this.btnPk])}},n.updateTimer=function(){var t=this;if(this.timer||(this.timer=new egret.Timer(1e3,15),this.timer.addEventListener(egret.TimerEvent.TIMER,function(){t.labTimer.label=--t.timerSecond+""},this),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){t.current==t.seatid&&t.main.net.send("Room","giveup",null)},this)),this.state&&this.current){if(this.timerSecond=15,this.labTimer.label=this.timerSecond+"",this.labTimer.visible=!0,this.current!=this.seatid){var e=this.getSeatByPos(this.current);this.labTimer.x=e.grpBox.x+e.imgCard2.x+.5*e.imgCard2.width,this.labTimer.y=e.grpBox.y+e.imgCard2.y-.5*this.labTimer.height-5,console.log(this.labTimer.x,this.labTimer.y)}else this.labTimer.x=242,this.labTimer.y=560;this.timer.reset(),this.timer.start()}else this.labTimer.visible=!1,this.timer.stop()},n.updateUI=function(t){void 0===t&&(t=!0),1==this.state&&this.current==this.seatid?(console.log("current=myself"),this.btnRaise.setEnable(this.currentgold<this.maxgold),t?this.showButtons(!0):(this.btnRaise.visible=!0,this.btnFollow.visible=!0,this.btnGiveup.visible=!0,this.btnPk.visible=!0,this.btnGiveup.x=85.5,this.btnGiveup.y=666,this.btnRaise.x=167.5,this.btnRaise.y=596,this.btnFollow.x=320.5,this.btnFollow.y=596,this.btnPk.x=397.5,this.btnPk.y=666),this.op=!0):(console.log("current=other"),t?this.showButtons(!1):(this.btnRaise.visible=!1,this.btnFollow.visible=!1,this.btnGiveup.visible=!1,this.btnPk.visible=!1),this.op=!1),this.btnLook.visible=1!=this.state||this.seats[0].look?!1:!0,this.state?(this.btnStartGame.visible=!1,this.btnDisband.visible=!1):(this.owner==this.main.user.uid?(this.btnStartGame.label="开始",this.btnDisband.visible=!0):(this.btnStartGame.label="准备",this.btnDisband.visible=!1),this.btnStartGame.visible=!0),this.labTotal.text=this.totalgold+"",this.updateTimer()},n.updateCard=function(){this.imgMyCard1.removeChildren(),this.imgMyCard2.removeChildren(),this.imgMyCard3.removeChildren(),this.state&&this.seats[0].look?(this.imgMyCard1.addChild(new Card(Math.floor(this.cards[2]/100),this.cards[2]%100)),this.imgMyCard2.addChild(new Card(Math.floor(this.cards[1]/100),this.cards[1]%100)),this.imgMyCard3.addChild(new Card(Math.floor(this.cards[0]/100),this.cards[0]%100))):(this.imgMyCard1.addChild(new egret.Bitmap(RES.getRes("card_back_png"))),this.imgMyCard2.addChild(new egret.Bitmap(RES.getRes("card_back_png"))),this.imgMyCard3.addChild(new egret.Bitmap(RES.getRes("card_back_png"))))},n.addCoin=function(t,e){var i="coin_"+t+"_png",n=new egret.Bitmap(RES.getRes(i));n.scaleX=.7,n.scaleY=.7;var s=Utils.rand(160,300),o=Utils.rand(310,400);if(e)if(e==this.seatid)n.x=this.imgMyCard2.x,n.y=this.imgMyCard2.y;else{var a=this.getSeatByPos(e);n.x=a.grpBox.x+a.imgCard2.x,n.y=a.grpBox.y+a.imgCard2.y}else n.x=s,n.y=o;if(this.addChild(n),this.coins.push(n),e){var h=egret.Tween.get(n);h.to({x:s,y:o},200,egret.Ease.sineOut)}},n.clearCoin=function(){for(var t in this.coins)this.removeChild(this.coins[t]);this.coins=[]},n.onBegin=function(t){this.main.user.uid==this.owner?this.main.net.send("Room","start",null):this.main.net.send("Room","ready",null)},n.updateFollowLable=function(){var t=this.seats[0].look?2:1;this.btnFollow.setLable(this.currentgold*t+"")},n.onInfo=function(t){this.roomid=t.id,this.seatid=t.seatid,this.totalgold=t.total,this.currentgold=t.point,this.maxgold=t.max,this.owner=t.owner,this.state=t.state,this.current=t.current,this.cards=t.cards,this.labRoomId.text=this.roomid+"",this.seats[1].hide(),this.seats[2].hide(),this.seats[3].hide(),this.seats[4].hide();for(var e in t.users){var i=t.users[e];this.onJoin(i)}var n=t.coins;for(var e in n)this.addCoin(n[e],0);this.updateCard(),this.labMyTotal.text=this.seats[0].total+"",this.labMyPoint.text=this.seats[0].point+"",this.labTip.text="底注：1  单注上限："+this.maxgold,this.updateFollowLable(),this.updateUI(!1)},n.onDisband=function(t){var e=this,i=t.list;i.length>0?Alert.show("该房间已被房主解散，点击查看结算数据",!1,function(){e.main.user.roomid=0,e.main.user.seatid=0;var t=[];for(var n in i){var s=i[n],o=e.getSeatByPos(s.seatid);t.push({name:o.name,total:s.total,point:s.point,king:s.king})}var a=new Balance(t,"结算","退出游戏",!0);a.horizontalCenter=0,a.verticalCenter=0,a.setDoneHandler(function(t){e.removeChild(t),Main.getInstance().showIndexScene()},e,[a]),e.addChild(a)},this):Alert.show("该房间已被房主解散，点击确定退出",!1,function(){e.main.user.roomid=0,e.main.user.seatid=0,Main.getInstance().showIndexScene()},this)},n.onOnline=function(t){var e=this.getSeatByPos(t.seatid);e.offline=0,e.updateState()},n.onOffline=function(t){var e=this.getSeatByPos(t.seatid);e.offline=1,e.updateState()},n.onJoin=function(t){var e=t.seatid,i=this.getSeatByPos(e);i.seatid=e,i.uid=t.uid,i.avatar=t.avatar,i.name=t.name,i.total=t.total,i.point=t.point,i.state=t.state,i.pos=e,i.look=t.look,i.lose=t.lose,i.giveup=t.giveup,i.offline=t.offline,i.updateState(),i.show()},n.onReady=function(t){var e=t.seatid,i=this.getSeatByPos(e);i.state=1,i.updateState(),i.myself&&(this.btnStartGame.visible=!1)},n.onStart=function(t){this.totalgold=t.total,this.currentgold=t.point,this.current=t.current,this.state=1;var e=t.userpoint;for(var i in this.seats){var n=this.seats[i];n.active&&(n.point=e,n.state=2,n.updateGold(),n.updateState(),this.addCoin(e,0))}this.updateFollowLable(),this.updateCard(),this.updateUI()},n.onRaise=function(t){this.totalgold=t.total,this.currentgold=t.point,this.current=t.current;var e=t.seatid,i=this.getSeatByPos(e);i.point=t.user_point,i.updateGold(),this.addCoin(t.add_point,e),this.updateFollowLable(),this.updateUI(),Utils.playSound("jiazhu-f")},n.onFollow=function(t){this.totalgold=t.total,this.current=t.current;var e=t.seatid,i=this.getSeatByPos(e);i.point=t.user_point,i.updateGold(),this.addCoin(t.add_point,e),this.updateUI(),Utils.playSound("push_coin-c")},n.onLook=function(t){this.cards=t.cards,this.seats[0].look=1,this.btnLook.visible=!1,this.updateFollowLable(),this.updateCard()},n.onLook2=function(t){var e=t.seatid,i=this.getSeatByPos(e);i.look=1,i.updateState(),Utils.playSound("wokanpai-f")},n.onGiveup=function(t){var e=t.seatid,i=this.getSeatByPos(e);i.giveup=1,i.state=0,i.updateState(),this.current=t.current,this.updateUI(),Utils.playSound("fangqi-f")},n.onPK=function(t){var e=this;this.totalgold=t.total,this.currentgold=t.point,this.current=t.current;var i=t.seatid,n=t.pkid,s=t.loseid,o=this.getSeatByPos(i),a=this.getSeatByPos(n);o.point=t.user_point,o.updateGold();var h=this.getSeatByPos(s);h.lose=1,h.state=0,h.updateState(),this.pking=!0,this.addCoin(t.add_point,i),this.updateUI();var r=new egret.Bitmap(RES.getRes("topbar_bg_png"));r.x=0,r.y=0,r.width=480,r.height=800,r.alpha=.2,this.addChild(r);var l=new VS([{name:o.name,point:o.total,avatar:o.avatar},{name:a.name,point:a.total,avatar:a.avatar}],s==i?1:2);l.x=0,l.y=310,l.setDoneHandler(function(t,i){setTimeout(function(t,e){t.pking=!1,t.removeChild(i),t.removeChild(e),t.pkdone&&t.pkdone()},1500,e,t,i)},this,[l,r]),this.addChild(l),Utils.playSound("pk-c")},n.onOver=function(t){this.state=0,this.totalgold=0,this.currentgold=0;var e=t.balance,i=t.list,n=t.list2,s=t.step,o=[],a=[];for(var h in i){var r=i[h],l=this.getSeatByPos(r.seatid);l.total=r.total,l.point=0,l.state=0,l.look=0,l.lose=0,l.giveup=0,l.updateGold(),l.updateState(),o.push({name:l.name,total:l.total,point:r.point,cards:r.cards})}if(e){this.main.user.roomid=0,this.main.user.seatid=0;for(var h in n){var r=n[h],l=this.getSeatByPos(r.seatid);a.push({name:l.name,total:r.total,point:r.point,king:r.king})}}var d=function(){var t=this,i=5==s?"查看结算":"继续游戏",n=new Balance(o,"第"+s+"局",i,!1);n.x=77,n.y=175,n.setDoneHandler(function(e,i,n){if(t.removeChild(e),i){var s=new Balance(n,"结算","退出游戏",!0);s.x=77,s.y=175,s.setDoneHandler(function(e){t.removeChild(e),Main.getInstance().showIndexScene()},t,[s]),t.addChild(s)}},this,[n,e,a]),this.addChild(n),this.pkdone=null};this.pking?this.pkdone=d:d.call(this),this.main.user.gold-=1,this.main.updateTopbar(),this.clearCoin(),this.updateUI()},e}(BaseComponent);egret.registerClass(Game,"Game");var Seat=function(){function t(){this.states=["null","cards_ready_png","cards_viewed_png","cards_givenup_png","cards_lose_png","cards_offline_png"]}var e=(__define,t),i=e.prototype;return i.hide=function(){this.myself||(this.grpBox.visible=!1),this.active=!1},i.show=function(){this.active=!0,this.myself||(this.labName.text=this.name,this.labTotal.text=this.total+"",this.imgAvatar.source=this.avatar?Utils.imageProxyUrl(this.avatar):"face_jpg",this.grpBox.visible=!0)},i.updateGold=function(){this.labTotal.text=this.total+"",this.myself&&(this.labPoint.text=this.point+"")},i.updateState=function(){this.myself||(this.offline?this.setState(t.STAT_OFFLINE):this.lose?this.setState(t.STAT_LOSE):this.giveup?this.setState(t.STAT_GIVEUP):this.look?this.setState(t.STAT_LOOK):1==this.state?this.setState(t.STAT_READY):this.setState(t.STAT_NONE))},i.setState=function(t){0==t?this.imgState.visible=!1:(this.imgState.source=this.states[t],this.imgState.visible=!0)},t.STAT_NONE=0,t.STAT_READY=1,t.STAT_LOOK=2,t.STAT_GIVEUP=3,t.STAT_LOSE=4,t.STAT_OFFLINE=5,t}();egret.registerClass(Seat,"Seat");var Index=function(t){function e(){t.call(this),this.main=Main.getInstance(),this.net=this.main.net,this.net.bind("Index.create",this.onCreate,this),this.net.bind("Index.join",this.onJoin,this),this.load("game/IndexSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.hideInput=function(){this.grpInput.visible=!1},n.initComponent=function(){var t=this;this.imgEnter.touchEnabled=!0,this.imgEnter.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.imgEnter.scaleX=.9,t.imgEnter.scaleY=.9,t.imgEnterBg.scaleX=.9,t.imgEnterBg.scaleY=.9},this),this.imgEnter.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.imgEnter.scaleX=1,t.imgEnter.scaleY=1,t.imgEnterBg.scaleX=1,t.imgEnterBg.scaleY=1},this),this.imgEnter.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onEnterTouch,this),this.imgEnterBg.addEventListener(egret.Event.ENTER_FRAME,function(e){t.imgEnterBg.rotation+=3},this),this.imgCreate.touchEnabled=!0,this.imgCreate.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.imgCreate.scaleX=.9,t.imgCreate.scaleY=.9,t.imgCreateBg.scaleX=.9,t.imgCreateBg.scaleY=.9},this),this.imgCreate.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.imgCreate.scaleX=1,t.imgCreate.scaleY=1,t.imgCreateBg.scaleX=1,t.imgCreateBg.scaleY=1},this),this.imgCreate.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onCreateTouch,this),this.imgCreateBg.addEventListener(egret.Event.ENTER_FRAME,function(e){t.imgCreateBg.rotation+=3},this);for(var e=0;9>=e;++e)this["btnNum"+e].addEventListener(egret.TouchEvent.TOUCH_TAP,this.onNumTouch,this);this.btnBackspace.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBackspace,this),this.btnCloseKeyboard.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onCloseKeyboard,this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onOk,this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.btnOk.scaleX=.9,t.btnOk.scaleY=.9},this),this.btnOk.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.btnOk.scaleX=1,t.btnOk.scaleY=1},this)},n.onNumTouch=function(t){this.labRoomId.text.length<8&&(this.labRoomId.text+=t.target.label)},n.onBackspace=function(t){var e=this.labRoomId.text;e.length>0&&(this.labRoomId.text=e.substring(0,e.length-1))},n.onCloseKeyboard=function(t){this.grpInput.visible=!1},n.onOk=function(t){this.main.net.send("Index","join",{roomid:this.labRoomId.text})},n.onEnterTouch=function(){this.main.user.roomid?Main.getInstance().showGameScene():(this.grpInput.visible=!0,this.labRoomId.text="")},n.onCreateTouch=function(){this.net.send("Index","create",null)},n.onCreate=function(t){this.main.user.roomid=t.roomid,this.main.user.seatid=t.seatid,this.main.showGameScene()},n.onJoin=function(t){this.main.user.roomid=t.roomid,this.main.user.seatid=t.seatid,this.main.showGameScene()},e}(BaseComponent);egret.registerClass(Index,"Index");var Login=function(t){function e(){t.call(this),this.main=Main.getInstance(),this.load("game/LoginSkin.exml")}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initComponent=function(){this.btnLogin.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onLoginTouch,this)
},n.onLoginTouch=function(){var t=new egret.HttpRequest;t.responseType=egret.HttpResponseType.TEXT,t.open("http://"+location.host+"/api.php?cmd=login&r="+Math.random()),t.addEventListener(egret.Event.COMPLETE,function(e){var i=JSON.parse(t.response);i.auth?(this.main.username=i.username,this.main.token=i.token,Main.getInstance().loadRes("game")):location.href=i.url},this),t.addEventListener(egret.IOErrorEvent.IO_ERROR,function(){Alert.show("登录认证出错",!1)},this),t.send()},e}(BaseComponent);egret.registerClass(Login,"Login");var ThemeAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getTheme=function(t,e,i,n){function s(t){e.call(n,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),i.call(n))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,s,this,RES.ResourceItem.TYPE_TEXT)},t}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var Utils=function(){function t(){}var e=(__define,t);e.prototype;return t.rand=function(t,e){var i=e-t-1,n=Math.random()*i;return Math.round(n)+t},t.playSound=function(t){var e=new egret.Sound;e.addEventListener(egret.Event.COMPLETE,function(t){e.play(0,1)},this),e.addEventListener(egret.IOErrorEvent.IO_ERROR,function(t){console.log("loaded error!")},this),e.load("resource/assets/sound/"+t+".mp3")},t.imageProxyUrl=function(t){return"webgl"==egret.Capabilities.renderMode?"http://"+location.host+"/api.php?cmd=image_proxy&url="+encodeURIComponent(t):t},t}();egret.registerClass(Utils,"Utils");